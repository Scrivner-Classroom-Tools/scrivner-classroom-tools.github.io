<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Behavior Chart</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f9;
            color: #4a90e2;
            overflow: hidden; /* Prevent scrolling */
        }
        .chart-container {
            text-align: center;
            width: 100%;
            max-width: 800px;
        }
        .seating-chart {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .row {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .seat {
            width: 100px;
            height: 100px;
            border: 2px solid #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            background-color: #e0e0e0;
            transition: background-color 0.3s;
            position: relative;
        }
        .seat.selected { border: 3px solid blue; }
        .seat.bad { background-color: #f7a6a6; }
        .seat.good { background-color: #a3e4a5; }
        .nickname-input {
            font-size: 12px;
            text-align: center;
            width: 100%;
        }
        .behavior-count {
            position: absolute;
            bottom: 5px;
            font-size: 12px;
            color: #333;
        }
    </style>
</head>
<body>

<div class="chart-container">
    <h1>Seating Chart</h1>
    <div class="seating-chart" id="seatingChart"></div>
    <div class="status" id="status">Press a number (1-7) to select a group.</div>
</div>

<script>
const SUPABASE_URL = "https://dqkjwnvdqzukhzvdtidr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxa2p3bnZkcXp1a2h6dmR0aWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5OTU4NjYsImV4cCI6MjA1NTU3MTg2Nn0.TCrjefgNWfi_YIPy-2PUBPBTPf5Dtn-DPQOVY3wV5RE";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    const seatingChart = document.getElementById('seatingChart');
    const statusDisplay = document.getElementById('status');
    let selectedStudents = [];
    let seats = [];
    let behaviorCounts = {};
    let nicknames = {};

    const rows = [[1, 2, 3, 4, 5, 6], [7, 8, 9, 10, 11, 12, 13, 14], [15, 16, 17, 18, 19, 20, 21, 22, 23], [24, 25, 26, 27]];
    const totalStudents = 30;

    async function testSupabaseConnection() {
        const { data, error } = await supabase.from('behavior_chart').select('student_id').limit(1);
        if (error) console.error('Supabase Connection Error:', error);
        else console.log('Supabase Connected:', data);
    }

    async function loadBehaviorData() {
        console.log("Fetching data from Supabase...");
        const { data, error } = await supabase.from('behavior_chart').select('*');
        
        if (error) {
            console.error('Error loading data:', error);
            return;
        }

        console.log("Data Retrieved:", data);

        if (!data || data.length === 0) {
            console.log("No data found. Initializing default data...");
            await initializeDefaultBehaviorData();
        } else {
            behaviorCounts = {};
            nicknames = {};
            data.forEach(entry => {
                behaviorCounts[entry.student_id] = { good: entry.good || 0, bad: entry.bad || 0 };
                nicknames[entry.student_id] = entry.nickname || '';
            });
            generateSeats(); // Ensure seats are generated
        }
    }

    async function initializeDefaultBehaviorData() {
        console.log("Initializing behavior data...");
        for (let i = 1; i <= totalStudents; i++) {
            await supabase.from('behavior_chart').upsert({ student_id: i, nickname: "", good: 0, bad: 0 });
            behaviorCounts[i] = { good: 0, bad: 0 };
            nicknames[i] = "";
        }
        generateSeats(); // Ensure seats are generated even after initialization
    }

    function generateSeats() {
        console.log("Generating seating chart...");
        seatingChart.innerHTML = ""; // Clear old content

        rows.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('row');

            row.forEach(studentId => {
                const seat = document.createElement('div');
                seat.classList.add('seat');
                seat.dataset.studentId = studentId;

                const nicknameInput = document.createElement('input');
                nicknameInput.classList.add('nickname-input');
                nicknameInput.value = nicknames[studentId] || "";
                nicknameInput.placeholder = "Nickname";
                nicknameInput.addEventListener('input', async (event) => {
                    nicknames[studentId] = event.target.value;
                    await supabase.from('behavior_chart').update({ nickname: event.target.value }).eq('student_id', studentId);
                });

                const behaviorDisplay = document.createElement('div');
                behaviorDisplay.classList.add('behavior-count');
                behaviorDisplay.textContent = `Good: ${behaviorCounts[studentId]?.good || 0} | Bad: ${behaviorCounts[studentId]?.bad || 0}`;

                seat.appendChild(nicknameInput);
                seat.appendChild(behaviorDisplay);
                seat.addEventListener('click', () => selectSeat(seat));

                rowDiv.appendChild(seat);
                seats.push(seat);
            });

            seatingChart.appendChild(rowDiv);
        });

        console.log("Seating chart generated successfully.");
    }

    function selectSeat(seat) {
        const studentId = parseInt(seat.dataset.studentId);
        seat.classList.toggle('selected');
        if (selectedStudents.includes(studentId)) {
            selectedStudents = selectedStudents.filter(id => id !== studentId);
        } else {
            selectedStudents.push(studentId);
        }
    }

    document.addEventListener('keydown', async (event) => {
        if (['g', 'b', '[', ']'].includes(event.key) && selectedStudents.length > 0) {
            for (let studentId of selectedStudents) {
                if (event.key === 'g') behaviorCounts[studentId].good++;
                if (event.key === 'b') behaviorCounts[studentId].bad++;
                if (event.key === '[') behaviorCounts[studentId].good = Math.max(0, behaviorCounts[studentId].good - 1);
                if (event.key === ']') behaviorCounts[studentId].bad = Math.max(0, behaviorCounts[studentId].bad - 1);

                await supabase.from('behavior_chart').update(behaviorCounts[studentId]).eq('student_id', studentId);
            }
            generateSeats();
        }
    });

    // Run functions
    testSupabaseConnection();
    loadBehaviorData();
</script>


</body>
</html>
